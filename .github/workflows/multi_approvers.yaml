name: 'multi-approvers'

on:
  pull_request:
    types:
      - 'opened'
      - 'edited'
      - 'reopened'
      - 'synchronize'
      - 'ready_for_review'
      - 'review_requested'
      - 'review_request_removed'
  pull_request_review:
    types:
      - 'submitted'
      - 'dismissed'

permissions:
  actions: 'write'
  contents: 'read'
  pull-requests: 'read'

concurrency:
  group: '${{ github.workflow }}-${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  download_members:
    runs-on: ubuntu-latest
    steps:
      - name: Download members.json
        id: 'download_members'
        run: |-
            MEMBERS_JSON="${RUNNER_TEMP}/${GITHUB_SHA:0:7}.members.json"

            # Download the file, passing in authentication to get a higher rate
            # limit: https://docs.github.com/en/rest/overview/resources-in-the-rest-api?apiVersion=2022-11-28#rate-limits-for-requests-from-github-actions
            curl "https://raw.githubusercontent.com/googleapis/google-auth-library-java/refs/heads/main/.github/workflows/members.json" \
              --silent \
              --fail \
              --location \
              --header "Authorization: Token ${{ github.token }}" \
              --output "${MEMBERS_JSON}"

            # Save the result to an output.
            echo "::notice::Downloaded members.json to ${MEMBERS_JSON}"
            echo "output-file=${MEMBERS_JSON}" >> "${GITHUB_OUTPUT}"
    outputs:
        members_path: ${{ steps.download_members.outputs.output-file }}

  multi-approvers:
    needs: download_members
    uses: './.github/workflows/multi-approvers.yml'
    with:
      org-members-path: ${{ needs.download_members.outputs.members_path }}